{% extends 'layout.html' %}
{% block body %}
{% load static %}
<main>
  <section class="d-flex align-items-center my-5 mt-lg-6 mb-lg-5">
    <div class="container">
      <div class="col-12 d-flex align-items-center justify-content-center">
        <div class="bg-white shadow-soft border rounded border-light p-4 p-lg-5 w-100 fmxw-650">
          <div class="text-center text-md-center mb-4 mt-md-0">
            <h1 class="mb-0 h3">Create an Account</h1>
          </div>
          <img src="{% static 'assets/personal_information.png' %}" style="position: relative;max-width: 30%;left: 35%;">
          <div class="card-body">
            <form name='register_form' method="post" action="{% url 'users:register'%}" class="mt-4">
              {% csrf_token %}
              <div class="form-group">
                <label for="firstname">FIRSTNAME</label>
                <div class="input-group mb-4">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><span class="fas fa-user"></span></span>
                  </div>
                  <input name="firstname" type="text" class="form-control" id="firstname" placeholder="Joe"
                    aria-label="firstname" required>
                </div>
              </div>
              <div class="form-group">
                <label for="lastname">LASTNAME</label>
                <div class="input-group mb-4">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><span class="fas fa-user"></span></span>
                  </div>
                  <input name="lastname" type="text" class="form-control" id="lastname" placeholder="Doe"
                    aria-label="lastname" required>
                </div>
              </div>
              <div class="form-group">
                <label for="username">USERNAME</label>
                <div class="input-group mb-4">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><span class="fas fa-user"></span></span>
                  </div>
                  <input name="username" class="form-control" id="username" placeholder="JohnDoe" type="text" required>
                </div>
              </div>
              <div class="form-group">
                <label for="email">EMAIL</label>
                <div class="input-group mb-4">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><span class="fas fa-envelope"></span></span>
                  </div>
                  <input name="email" class="form-control" id="email" placeholder="johndie@example.com" type="email" required>
                </div>
              </div>
              <div class="form-group">
                <label for="password">PASSWORD</label>
                <div class="input-group mb-4">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><span class="fas fa-unlock-alt"></span></span>
                  </div>
                  <input name="password" type="text" class="form-control" id="password"
                    style="-webkit-text-security:disc;" placeholder="Password" aria-label="Password" required>
                </div>
              </div>
              <input type="hidden" name="form_name" value="register_form">
              <input type="submit" class="btn btn-primary form-group justify-content-center" id="register-btn" value="Register">
            </form>
            <p>Already have an account?
              <a href="{% url 'users:login' %}">Click here</a>.
            </p>
          </div>
          <div>
          </div>
        </div>
      </div>
    </div>
    </div>
    </div>
    </div>
  </section>
  <div class="modal fade" id="CameraModal" tabindex="-1" aria-labelledby="cameraModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header" style="display: flex; flex-direction: column;">
          <h5 class="modal-title" id="cameraModalLabel">Hello, we need to take a picture</h5>
          <div style="display: flex; flex-direction: column;font-size: small;color: darkgrey;">
            <span>Please sit straight.</span>
            <span>Align yourself in the center of the frame.</span>
            <span>Ensure your background is plain.</span>
          </div>          

          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="margin-top: -40px;"></button>
        </div>
        <div class="modal-body">
          <div class="container" >
            <video id="cameraFeed" preload="auto" autoplay style="width: 100%; height: auto;"></video>
            <canvas id="photoCanvas" style="display: none; "></canvas>
            <img id="capturedPhoto" style="display: none;margin-bottom:10px;width: 100%; height: auto;">
          </div>
          <button type="button" id="retakePicture" style="display: none;" class="btn btn-primary">Retake</button>
          <button type="button" id="takePicture" class="btn btn-primary">Take my picture</button>
       

          <button type="button" id="savePicture" style="display: none;" class="btn btn-primary">Save</button>
          <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
        </div>        
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="CameraModal" tabindex="-1" aria-labelledby="cameraModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header" style="display: flex; flex-direction: column;">
          <h5 class="modal-title" id="cameraModalLabel">Hello, we need to take a picture</h5>
          <div style="display: flex; flex-direction: column;font-size: small;color: darkgrey;">
            <span>Please sit straight.</span>
            <span>Align yourself in the center of the frame.</span>
            <span>Ensure your background is plain.</span>
          </div>          

          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="margin-top: -40px;"></button>
        </div>
        <div class="modal-body">
          <div class="container" >
            <video id="cameraFeed" preload="auto" autoplay style="width: 100%; height: auto;"></video>
            <canvas id="photoCanvas" style="display: none; "></canvas>
            <img id="capturedPhoto" style="display: none;margin-bottom:10px;width: 100%; height: auto;">
          </div>
          <button type="button" id="retakePicture" style="display: none;" class="btn btn-primary">Retake</button>
          <button type="button" id="takePicture" class="btn btn-primary">Take my picture</button>
       

          <button type="button" id="savePicture" style="display: none;" class="btn btn-primary">Save</button>
          <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
        </div>        
      </div>
    </div>
  </div>
</main>
<script>

  $(document).ready(function () {
    function dataURLtoBlob(dataURL) {
      var arr = dataURL.split(',');
      var mime = arr[0].match(/:(.*?);/)[1];
      var bstr = atob(arr[1]);
      var n = bstr.length;
      var u8arr = new Uint8Array(n);

      while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
      }

      return new Blob([u8arr], { type: mime });
    }

    var imageData;
    var video = document.getElementById('cameraFeed');
    var canvas = document.getElementById('photoCanvas');
    var photo = document.getElementById('capturedPhoto');
    var save = document.getElementById('savePicture');
    var retake = document.getElementById('retakePicture');
    var takePicture = document.getElementById('takePicture');


    $('#CameraModal').on('shown.bs.modal', function () {
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: true })
          .then(function (stream) {
            var video = document.getElementById('cameraFeed');
            video.srcObject = stream;

          })
          .catch(function (error) {
            console.error('Error accessing webcam: ', error);
          });
      }
    });

    $('#takePicture').click(function () {

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

      photo.src = canvas.toDataURL('image/png');
      var csrfToken = $('[name=csrfmiddlewaretoken]').val();
      var blob = dataURLtoBlob(canvas.toDataURL('image/png'));
      var formData = new FormData();
      formData.append("file", blob);
      $.ajax({
        url: '/validate_image/',
        type: "POST",
        data: {
          image_data: canvas.toDataURL('image/png'),
          csrfmiddlewaretoken: csrfToken,
        },

        success: function (response) {
          console.log(response['message']);
          if (!response['message']) {
            video.style.display = 'none';
            photo.style.display = 'block';
            imageData = canvas.toDataURL('image/png');
            takePicture.style.display = 'none';
            save.style.display = 'inline';
            retake.style.display = 'inline';
          }
          else {
            Notiflix.Notify.failure(response['message']);

          }

        },
        error: function (error) {
          console.error('Error saving the image:', error);

        }
      });

    });

    $('#savePicture').click(function () {
      var csrfToken = $('[name=csrfmiddlewaretoken]').val();
      $.ajax({
        type: 'POST',
        url: '/save_image/',
        data: {
          image_data: imageData,
          user: "{{user.id}}",
          csrfmiddlewaretoken: csrfToken,
        },
        success: function (response) {
          var takemypicbtn = document.getElementById('takemypicbtn');

          console.log('Image saved to the server.');
          $('#CameraModal').modal('hide');
          $('.modal-backdrop').hide()
          takemypicbtn.style.display = 'none';

          $("#question").append(`<button type="button" class="btn btn-primary rounded" disabled>Verified</button>`)

        },
        error: function (error) {
          console.error('Error saving the image:', error);
        }
      });
    });



    $("#retakePicture").click(function () {

      video.style.display = 'block';
      photo.style.display = 'none';
      takePicture.style.display = 'inline';
      save.style.display = 'none';
      retake.style.display = 'none';
      $(".container").css("margin-bottom", "10px");


    })


    $('#register-btn').click(function(e){
        e.preventDefault();

        let username = $('#username').val()
        let password = $('#password').val()
        let firstname = $('#firstname').val()
        let lastname = $('#lastname').val()
        let email = $('#email').val()
        let csrf = $('input[name=csrfmiddlewaretoken]').val()

        if (!username || !password || !email){
            Notiflix.Notify.failure("Required credentials should be filled properly")
        } else {
            datatosend = { username: username, firstname: firstname, lastname: lastname, email: email, password: password,csrfmiddlewaretoken: csrf  }

            $.ajax({
                url: "{% url 'users:register' %}",
                method: "POST",
                data: datatosend,
                success: function(response){
                    if (response.status == 'success') {
                        Notiflix.Notify.success(response.message)
                        setTimeout(function(){
                        location.href = "{% url 'users:login' %}";
                        },2000);
                    } else {
                        Notiflix.Notify.failure(response.message)
                    }
                }
            })
        }

        
    })


  });



</script>
<script src='{% static "js/jquery.min.js"%}'></script>
<script src='{% static "js/popper.js"%}'></script>
<script src='{% static "js/bootstrap.min.js"%}'></script>
<script src='{% static "js/main.js"%}'></script>
<script src='{% static "js/notiflix-aio-3.2.6.min.js" %}'></script>
<script src="https://cdn.webrtc-experiment.com/RecordRTC.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
{% endblock %}